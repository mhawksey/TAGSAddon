<script>
  $(function() {
  /**
   * Initialisation
   */
    poll();
    var SHEETS = {};
    var DEFAULT_COLS = [];
    script.settingsSave('doc', 'collect');

    getSheets(); // populate sheets select
    
    // Collection submit button setup
    autoScheduleButtonHandler(auto_collect);
    google.script.run.withSuccessHandler(setLastRunTooltipHandler).lastRun();
    
    // data range mod for sheet export value
    $('#auto_export_num').on("change click input", function(e) {
            var i = $(this).siblings(".thumb");
            i.find(".value").html($(this).val()+'K');
    });
    
    // setting up columns selection and defaults
    $.map(COLS['search/tweets'], function(grp) {
      $.map(grp.children, function(obj) {
        obj.text = obj.id;
        if (use_default_cols && obj.is_default) {
          obj.selected = true;
        } 
        if (obj.is_default) {
          DEFAULT_COLS.push(obj.id);
        }
      });

    });
    $('#columns').select2({
      data: COLS['search/tweets']
    });
    
    $('#tw_input').characterCounter()
    
    // setup different data collection types
    var endpoint_select = $('#endpoint');
    $.each(ENDPOINTS, function(idx) {
      endpoint_select.append($('<option>', { value: idx })
          .text(ENDPOINTS[idx].label))
    });
    
    endpoint_select.on('change', function(e) {
      var endpoint = ENDPOINTS[$(this).val()];
      $('#tw_input').attr('placeholder', endpoint.placeholder)
                    .attr('data-tooltip', endpoint.tooltip); 
      $('label[for="tw_input"]').text(endpoint.label);
      $('.tooltipped').tooltip({delay: 100});
      console.log(endpoint);
    });
    
    
    /*
    $('#end_collect_time_in').pickatime({
      default: 'now', // Set default time: 'now', '1:30AM', '16:30'
      fromnow: 0, // set default time to * milliseconds from now (using with default = 'now')
      twelvehour: false, // Use AM/PM or 24-hour format
      donetext: 'OK', // text for done-button
      cleartext: 'Clear', // text for clear-button
      canceltext: 'Cancel', // Text for cancel-button
      autoclose: false, // automatic close timepicker
      ampmclickable: true, // make AM PM clickable
      aftershow: function() {} //Function for after opening timepicker
    });*/

    /**
     * Sheet select dropdown and poll for changes
     */
    function poll(interval) {
      interval = interval || 2000;
      setTimeout(function() {
        if (ifvisible.now()) {
          getSheets();
        }
        poll();
      }, interval);
    };

    function getSheets() {
      google.script.run.withSuccessHandler(showSheetNamesHandler)
        .getSheetNames(SHEETS);
    }



    /**
     * Event Handlers
     */
    $('[id^=run_]').on('click', function(e) {
      e.preventDefault(); //prevent form from submitting
      if(this.form.checkValidity()){
      
      var type = $(e.currentTarget).prop("id");
      $('[id^=run_]').prop("disabled", true);
      $('#loader').show();
      progressPolling();
      if (type === 'run_auto'){
        google.script.run.withSuccessHandler(autoCollectSetupHandler)
            .autoCollectSetup($(e.currentTarget).find('span').text());
      } else { 
        google.script.run.withSuccessHandler(collectionResultsHandler)
          .collectionRun();
      }
     }

    });

    $('#columns_reset').on('click', function() {
      $('#columns').val(DEFAULT_COLS).trigger("change");
    });

    /**
     * Success Handlers
     */
     function showSheetNamesHandler(sheets) {
      if (sheets) {
        $('#sheetId').html('<option value="" disabled selected>Select sheet </option>');
        sheets.options.forEach(function(s) {
          $('#sheetId')
            .append($('<option></option>')
              .attr('value', s.value)
              .text(s.text));
        });
        $('#sheetId option[value=' + sheets.selected + ']').prop('selected', 'selected');
        $('select').material_select();
        SHEETS = sheets;
      }
    }
    
    function collectionResultsHandler(resp) {
      console.log(resp)
      if (resp.status === 'import') {
        resp.import = true;
        resp.status = 'importing';
        progressPolling();
        google.script.run.withSuccessHandler(collectionResultsHandler)
          .collectionRun(result);

      }
      if (resp.result.run){
        setLastRunTooltipHandler(resp.result.run);
      }
      $('[id^=run_]').prop("disabled", false);
      $('#loader').hide();
    }
    
    function autoCollectSetupHandler(result) {
      console.log(result);
      autoScheduleButtonHandler(result.data);
      $('[id^=run_]').prop("disabled", false);
      $('#loader').hide();
    }
    
    function autoScheduleButtonHandler(canStart){
      var action_but = $('#run_auto');
      if (canStart === 0){
        action_but.addClass('action');
        action_but.removeClass('create');
        action_but.find('span').text('Start');
      } else {
        action_but.removeClass('action');
        action_but.addClass('create');
        action_but.find('span').text('Stop');
      }
    }
    
    function setLastRunTooltipHandler(data){
      if (data){
        $('[id^=run_]').attr('data-tooltip', 'Last run '+data);
        $('.tooltipped').tooltip({delay: 100});
      }
    }
    
    // progress polling for data collection
    var progressPoller;
    function progressPolling(interval) {
      interval = interval || 1000;
      progressPoller = setTimeout(function() {
        google.script.run.withSuccessHandler(function(at) {
          var bar = $('#loader > div');
          if (at == undefined || at.stage == 'finished') {
            clearTimeout(progressPoller);
            bar.removeClass('determinate');
            bar.addClass('indeterminate');
            bar.css('width', '');
          } else {
            if (at.stage == 'finished' || at.stage == 'inserting-data') {
              bar.removeClass('determinate');
              bar.addClass('indeterminate');
              bar.css('width', '');
            } else if (at.stage == 'get-tweets') {
              if (bar.hasClass('indeterminate')) {
                bar.removeClass('indeterminate');
                bar.addClass('determinate');
              }
              bar.css('width', at.data + '%');
            }
          }
        }).getDocumentCache('collectionRun');
        progressPolling();
      }, interval);
    };
    


  });
</script>