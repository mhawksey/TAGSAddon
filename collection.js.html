<script>
  $(function() {
    poll();
    var SHEETS = {};
    script.settingsSave('doc', 'collect');

    getSheets();
    
    $('.js-example-basic-multiple').select2({
      data: COLS['search/tweets']
    });

    function poll(interval) {
      interval = interval || 2000;
      setTimeout(function() {
        if (ifvisible.now()) {
          getSheets();
        }
        poll();
      }, interval);
    };

    function getSheets() {
      google.script.run.withSuccessHandler(showSheetNames)
        .getSheetNames(SHEETS);
    }

    function showSheetNames(sheets) {
      if (sheets) {
        $('#sheetId').html('<option value="" disabled selected>Select sheet </option>');
        sheets.options.forEach(function(s) {
          $('#sheetId')
            .append($('<option></option>')
              .attr('value', s.value)
              .text(s.text));
        });
        $('#sheetId option[value=' + sheets.selected + ']').prop('selected', 'selected');
        $('select').material_select();
        SHEETS = sheets;
      }
    }
    $('#basic_settings').on('submit', function(e) { 
      e.preventDefault();  //prevent form from submitting
      $('[id^=run_]').prop("disabled", true);
      $('#loader').show();
      google.script.run.withSuccessHandler(collectionResults)
        .collectionRun();

    });
    
    function collectionResults(result){
      if (result === 'yes'){
      google.script.run.withSuccessHandler(collectionResults)
        .collectionRun({import:true});
      }
      console.log(result);
      $('[id^=run_]').prop("disabled", false);
      $('#loader').hide();
    }
  });
</script>