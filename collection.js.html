<script>
  $(function() {
    poll();
    var SHEETS = {};
    var DEFAULT_COLS = [];
    script.settingsSave('doc', 'collect');

    getSheets();
    $.map(COLS['search/tweets'], function (grp) {
      $.map(grp.children, function (obj){
      obj.text = obj.id;
      if (use_defaults && obj.is_default){
        obj.selected = true;
      } else if (obj.is_default){
        DEFAULT_COLS.push(obj.id);
      }
      });
     
      });
    
    $('#columns').select2({
      data: COLS['search/tweets']
    });
    

    function poll(interval) {
      interval = interval || 2000;
      setTimeout(function() {
        if (ifvisible.now()) {
          getSheets();
        }
        poll();
      }, interval);
    };

    function getSheets() {
      google.script.run.withSuccessHandler(showSheetNames)
        .getSheetNames(SHEETS);
    }

    function showSheetNames(sheets) {
      if (sheets) {
        $('#sheetId').html('<option value="" disabled selected>Select sheet </option>');
        sheets.options.forEach(function(s) {
          $('#sheetId')
            .append($('<option></option>')
              .attr('value', s.value)
              .text(s.text));
        });
        $('#sheetId option[value=' + sheets.selected + ']').prop('selected', 'selected');
        $('select').material_select();
        SHEETS = sheets;
      }
    }
    
    // Event Handlers
    $('#basic_settings').on('submit', function(e) { 
      e.preventDefault();  //prevent form from submitting
      $('[id^=run_]').prop("disabled", true);
      $('#loader').show();
      google.script.run.withSuccessHandler(collectionResults)
        .collectionRun();

    });
    
    $('#columns_reset').on('click', function(){
      $('#columns').val(DEFAULT_COLS).trigger("change");
    });
    
    function collectionResults(result){
      if (result === 'yes'){
      google.script.run.withSuccessHandler(collectionResults)
        .collectionRun({import:true});
      }
      console.log(result);
      $('[id^=run_]').prop("disabled", false);
      $('#loader').hide();
    }
  });
</script>